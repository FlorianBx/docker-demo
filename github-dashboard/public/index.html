<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🏆 GitHub Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
  <main class="container" x-data="githubDashboard()" x-init="fetchData()">
    <header style="margin-top: 2rem">
      <h1>🏆 GitHub Dashboard</h1>
      <p>Live Contributors Statistics</p>
    </header>

    <section style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      <article>
        <header><strong x-text="stats.topContributor || 'Loading...'"></strong></header>
        <p>Top Contributor</p>
      </article>
      <article>
        <header><strong x-text="stats.totalCommits.toLocaleString()"></strong></header>
        <p>Total Contributions</p>
      </article>
      <article>
        <header><strong x-text="stats.activeDevs"></strong></header>
        <p>Active Developers</p>
      </article>
      <article>
        <header><strong x-text="stats.totalStars.toLocaleString()"></strong></header>
        <p>Total Stars</p>
      </article>
    </section>

    <section>
      <h2>🥇 Top Contributors</h2>
      <div x-show="loading" style="text-align: center; opacity: 0.7;">
        <p><em>Loading contributors...</em></p>
      </div>
      <div x-show="!loading"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
        <template x-for="(contributor, index) in contributors.slice(0, 8)" :key="contributor.login">
          <article style="display: flex; align-items: center; gap: 1rem;">
            <img :src="contributor.avatar_url" :alt="contributor.login"
              style="width: 50px; height: 50px; border-radius: 50%;">
            <div>
              <strong x-text="`#${index + 1} ${contributor.login}`"></strong>
              <br>
              <small x-text="`${contributor.contributions.toLocaleString()} contributions`"></small>
            </div>
          </article>
        </template>
      </div>
    </section>

    <section>
      <h2>📚 Monitored Repositories</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
        <template x-for="(repo, index) in repositories" :key="index">
          <article>
            <header>
              <strong x-text="repo.name"></strong>
            </header>
            <p>
              ⭐ <span x-text="repo.stargazers_count.toLocaleString()"></span> stars<br>
              🔀 <span x-text="repo.forks_count.toLocaleString()"></span> forks<br>
              👥 <span x-text="repo.contributors_count || 0"></span> contributors
            </p>
          </article>
        </template>
      </div>
    </section>
  </main>

  <script>
    function githubDashboard() {
      return {
        loading: true,
        contributors: [],
        repositories: [],
        stats: {
          topContributor: '',
          totalCommits: 0,
          activeDevs: 0,
          totalStars: 0
        },
        repos: [
          // 'DonkeySchool/Andreane',
          'FlorianBx/nvim_config',
          'FlorianBx/weba11ylab',
          'FlorianBx/Rise-of-Knowledges',
          'FlorianBx/my-little-starter',
          'FlorianBx/ng-croissant',
          'FlorianBx/pres_html',
          'FlorianBx/pres_js_v2',
          'FlorianBx/presTypescript',
          'FlorianBx/presAngular'
        ],

        async fetchData() {
          this.loading = true;

          try {
            const repoPromises = this.repos.map(async repo => {
              const [owner, name] = repo.split('/');
              const [repoResponse, contributorsResponse] = await Promise.all([
                fetch(`/api/github/${owner}/${name}`),
                fetch(`/api/github/${owner}/${name}/contributors`)
              ]);

              const repoData = await repoResponse.json();
              const contributorsData = await contributorsResponse.json();

              return {
                ...repoData,
                contributors: contributorsData,
                contributors_count: contributorsData.length
              };
            });

            const repos = await Promise.all(repoPromises);
            this.repositories = repos;

            const allContributors = [];
            let totalStars = 0;
            let totalCommits = 0;

            repos.forEach(repo => {
              totalStars += repo.stargazers_count;
              repo.contributors.forEach(contributor => {
                totalCommits += contributor.contributions;
                const existing = allContributors.find(c => c.login === contributor.login);
                if (existing) {
                  existing.contributions += contributor.contributions;
                } else {
                  allContributors.push({...contributor});
                }
              });
            });

            allContributors.sort((a, b) => b.contributions - a.contributions);
            this.contributors = allContributors;

            this.stats = {
              topContributor: allContributors[0]?.login || 'N/A',
              totalCommits,
              activeDevs: allContributors.length,
              totalStars
            };

            this.loading = false;

            setTimeout(() => this.fetchData(), 60000);
          } catch (error) {
            console.error('Error fetching data:', error);
            this.loading = false;
            setTimeout(() => this.fetchData(), 60000);
          }
        }
      }
    }
  </script>
</body>

</html>
